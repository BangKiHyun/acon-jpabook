## 프록시

### 프록시 기초

JPA에서 식별자로 엔티티 하나를 조회할 때 EntityManager.find()를 사용한다.
이 메서드는 영속성 컨텍스트가 없으면 DB를 조회하게 되는데,
이렇게 엔티티를 직접 조회하면 조회한 엔티티가 실제 사용하든 안하든 DB를 조회하게 된다.

엔티티를 실제 사용하는 시점까지 DB조회를 미루고 싶다면 **EntityManager.getReference()** 메서드를 사용하면된다.

- EntityManager.getReference()

  이 메서드를 호출할 때 JPA는 DB를 조회하지 않고 실제 엔티티 객체도 생성하지 않는다. 대신에 DB접근을 위임한 **프록시 객체를 반환**한다.

### 프록시의 특징(기초)

프록시 클래스는 실제 클래스를 상속받아 실제 클래스와 겉 모양이 같다.
따라서 사용하는 입장에서는 이것이 진짜 객체인지 프록시 객체인지 구분하지 않고 사용하면 된다.

프록시 객체는 실제 객체에 대한 참조(reference)를 보관한다.
프록시 객체의 메서드를 호출하면 프록시 객체는 실제 객체의 메서드를 호출한다.

### 프록시 객체의 초기화

프록시 객체는 member.getName()처럼 실제 사용될 때 데이터베이스를 조회해서 실제 엔티티 객체를 생성하는데 이것을 프록시 객체의 초기화라 한다.

~~~
//MemberProxy 반환
Member member = em.getReference(Member.class, "id1");
memeber.getName(); //1. getName();

class MemberProxy extends Member {
	Member proxyMember = nul; //실제 엔티티 참조
	
	public String getName(){
		//2. 초기화 요청
		//3. DB 조회
		//4. 실제 엔티티 생성 및 보관
		this.proxyMember = .../
		
		//5. proxyMember.getName();
		return target.getName();
	}
}
~~~

위 코드를 동작은 분석해 보면

1. 프록시 객체에 member.getName() 을 호출해서 실제 데이터를 조회한다.
2. 프록시 객체는 실제 엔티티가 생성되어 있지 않으면 영속성 컨텍스트에 실제 엔티티 생성을 요청한다.(초기화)
3. 영속성 컨텍스트는 DB를 조회해서 실제 엔티티 객체를 생성한다.
4. 프록시 객체는 생성된 실제 엔티티 객체의 참조를 Member proxyMember 멤버변수에 보관한다.
5. 프록시 객체는 실제 엔티티 객체의. getName()을 호출해서 결과를 반환한다.



### 프록시의 특징

- 프록시 객체는 처음 사용할 때 한 번만 초기화된다.
- 프록시 객체를 초기화한다고 프록시 객체가 실제 엔티티로 바꾸는 것이 아니다.
  프록시 객체가 초기화되면서 프록시 객체를 통해서 실제 엔티티에 접근할 수 있다.
- 프록시 객체는 원본 엔티티를 상속받은 객체이므로 타입 체크 시에 주의해서 사용해야 한다.
- 영속성 컨텍스트에 찾는 엔티티가 이미 있으면 DB를 조회할 필요가 없으므로 em.getReference()를 호출해도 프록시가 아닌 실제 엔티티를 반환한다.
- 초기화는 영속성 컨텍스트의 도움을 받아야 가능하기 때문에, 준영속 상태의 프록시를 초기화하면 에러가 발생한다.

