## 양방향 연관관계

엄밀히 말하면 객체에는 양방향 연관관계라는 것이 없다.
서로 다른 단방향 연관관계 2개를 애플리케이션 로직으로 잘 묶어서 양방향인 것처럼 보이게 할 뿐이다.

반면 데이터베이스 테이블은 외래 키 하나로 양쪽이 서로 조인할 수 있다. 따라서 테이블은 외래 키 하나만으로 양방향 연관관계를 맺는다.

엔티티를 단방향으로 매핑하면 참조를 하나만 사용하므로 이 참조로 외래 키를 관리하면 된다.
하지만 엔티티를 양방향으로 매핑하면 두 곳에서 서로 참조를 해야한다.

**엔티티를 양방향으로 연관관계를 설정하면 객체의 참조는 둘인데 외래 키는 하나**다. 따라서 둘 사이에 차이가 발생한다.
그렇다면 둘 중 어떤 관계를 사용해서 외래 키를 관리해야 할까?

이런 차이로 **두 객체 연관관계 중 하나를 정해서 테이블의 외래 키를 관리해야 하는데 이를 연관관계의 주인**이라 한다.



### 양방향 매핑의 규칙: 연관관계의 주인

- 양방향 연관관계 매핑 시 두 연관관계 중 하나를 연관관계의 주인으로 정해야 한다.
- **연관관계의 주인만이 데이터베이스 연관관계와 매핑되고 외래 키를 관리(등록, 수정, 삭제)할 수 있다.**
- 반면에 주인이 아닌 쪽은 읽기만 할 수 있다
- 즉, **연관관계의 주인을 정한다는 것은 외래 키 관리자를 선택**하는 것이다.

#### mappedBy 속성

- 주인은 mappedBy 속성을 사용하지 않는다.

- **주인이 아니면 mappedBy 속성을 사용**해서 속성의 값으로 연관관계의 주인을 정해야 한다.

  

### 연관관계의 주인은 외래 키가 있는 곳

연관관계의 주인은 테이블에 외래 키가 있는 곳으로 정해야 한다. 

여기서는 회원 테이블이 외래 키를 갖고 있으므로 Member.team이 주인이 된다.
주인이 아닌 Team.members 에는 mappedBy="team" 속성을 사용해 주인이 아님을 설정한다.

#### 참고

- DB의 테이블 다대일, 일대단 관계에서 **항상 다 쪽이 외래 키를 가진다.**
- 다 쪽인 **@ManyToOne은 항상 연관관계의 주인**이 되므로 mappedBy를 설정할 수 없다.
  즉, @ManyToOne에는 mappedBy 속성이 없다.



### 양방향 연관관계의 주의점

양방향 연관관계를 설정하고 연관관계의 주인에는 값을 입력하지 않고, 주인이 아닌 곳에만 값을 입력하는 경우가 빈번하다.
주인이 아닌 곳에 입력된 값은 외래 키에 영향을 주지 않기 때문에 DB에 저장될 때 무시된다.
DB에 외래 키 값이 정상적으로 저장되지 않으면 이것부터 의심해보자.

또한 양방향 연관관계 설정시 객체 관점에서 양쪽 방향에 모두 값을 입력해주는 것이 가장 안전다하다.

~~~
member1.setTeam(team1);
member2.setTeam(team2);

List<Member> members = team1.getMembers();
~~~

위와 같은 상황에서 members의 크기를 보면 0이라는 값이 출력된다. setTeam() 메서드를 아래와 같이 바꿔야 한다.

~~~
public void setTeam(Team team){
	this.team = team;
	team.getMembers().add(this);
}
~~~

위 코드에도 문제가 있다. 아래 코드를 살펴보자.

~~~
member.setTeam(teamA);
member.setTeam(teamB);
Member findMember = teamA.getMember(); //member가 여전히 조회된다.
~~~

teamA 에서 teamB로 바꿨음에도 불구하고 teamA는 여전히 member를 조회한다.
teamA -> member의 연관관계를 제거하지 않았기 떄문이다. 연관관계를 삭제하는 코드 또한 추가해야한다.

~~~
public void setTeam(Team team){
	if(this.team != null){
		this.team.getMembers().remove(this);
	}
	this.team = team;
	team.getMembers().add(this);
}
~~~



### 정리

- 단방향 매핑만으로 테이블 객체의 연관관계 매핑은 이미 완료되었다.
- 단방향을 양방향으로 만들면 반대바향으로 객체 그래프 탐색 기능이 추가된다.
- 양방향 연관관계를 매핑하려면 객체에서 양쪽 방향을 모두 관리해야 한다.

양방향 매핑은 단방행 매핑에 비해 매우 복잡하다. 복잡함에 비해 장점은 반대방향으로 객체 그래프 탐색 기능이 추가된 것뿐이다.
결론은 우선 단방향 매핑을 사용하고 반대 방향으로 객체 그래프 탐색 기능이 필요한 경우에만 양방향을 사용하도록 코드를 추가하자!!

